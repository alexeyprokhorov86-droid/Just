# üìß Email Logger

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ—á—Ç—ã —Å AI-–∞–Ω–∞–ª–∏–∑–æ–º –¥–ª—è Frumelad (totsamiy.com).

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 70 –ø–æ—á—Ç–æ–≤—ã—Ö —è—â–∏–∫–æ–≤** —á–µ—Ä–µ–∑ IMAP (NIC.ru)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ç–æ–∫ –ø–µ—Ä–µ–ø–∏—Å–∫–∏** –ø–æ References/In-Reply-To
- **AI-—Å–∞–º–º–∞—Ä–∏** –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–π (Claude/Gemini)
- **–ê–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π** (OCR, Vision API)
- **Telegram-–±–æ—Ç** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RAG** (pgvector –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞)

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
email_logger/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ .env.example      # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ settings.py       # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ 001_init_email_logger.sql  # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ imap_client.py         # IMAP –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ sync_service.py        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—á—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ thread_manager.py      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∞–º–∏ + AI
‚îÇ   ‚îî‚îÄ‚îÄ attachment_processor.py # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îî‚îÄ‚îÄ email_commands.py      # –ö–æ–º–∞–Ω–¥—ã Telegram –±–æ—Ç–∞
‚îú‚îÄ‚îÄ main.py               # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îî‚îÄ‚îÄ requirements.txt
```

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cd /opt
git clone <repo> email_logger
cd email_logger

python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—ë–º –±–∞–∑—É
sudo -u postgres createdb email_logger

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
psql -d email_logger -f db/001_init_email_logger.sql
```

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```bash
cp config/.env.example config/.env
nano config/.env
```

–ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
- `DATABASE_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `EMAIL_N` ‚Äî —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—á—Ç–æ–≤—ã—Ö —è—â–∏–∫–æ–≤
- `ROUTERAI_API_KEY` ‚Äî –∫–ª—é—á –¥–ª—è AI API
- `TELEGRAM_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞

### 4. –ó–∞–ø—É—Å–∫

```bash
# –ù–∞–ø—Ä—è–º—É—é
python main.py

# –ß–µ—Ä–µ–∑ systemd
sudo cp email_logger.service /etc/systemd/system/
sudo systemctl enable email_logger
sudo systemctl start email_logger
```

## ü§ñ –ö–æ–º–∞–Ω–¥—ã Telegram –±–æ—Ç–∞

### –í–µ—Ç–∫–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
- `/open_threads` ‚Äî —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–µ—Ç–æ–∫
- `/thread_<id>` ‚Äî –¥–µ—Ç–∞–ª–∏ –≤–µ—Ç–∫–∏
- –ö–Ω–æ–ø–∫–∏: üìú –ü–µ—Ä–µ–ø–∏—Å–∫–∞, ü§ñ –°–∞–º–º–∞—Ä–∏, ‚úÖ –†–µ—à–µ–Ω–∞, üì¶ –ê—Ä—Ö–∏–≤

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- `/assign_email` ‚Äî –Ω–∞–∑–Ω–∞—á–∏—Ç—å email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
- `/email_stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
- `/sync_status` ‚Äî —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `/force_sync` ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ü–æ–∏—Å–∫
- `/search_email` ‚Äî –ø–æ–∏—Å–∫ –ø–æ –ø–∏—Å—å–º–∞–º

## üìä –°—Ö–µ–º–∞ –ë–î

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `employees` | –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (—Å–≤—è–∑—å —Å Telegram –∏ 1–°) |
| `employee_emails` | –°–≤—è–∑—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å email |
| `monitored_mailboxes` | –ú–æ–Ω–∏—Ç–æ—Ä–∏–º—ã–µ –ø–æ—á—Ç–æ–≤—ã–µ —è—â–∏–∫–∏ |
| `email_threads` | –í–µ—Ç–∫–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å AI-—Å–∞–º–º–∞—Ä–∏ |
| `email_messages` | –ü–∏—Å—å–º–∞ |
| `email_attachments` | –í–ª–æ–∂–µ–Ω–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º |

### –ü–æ–ª—è –≤–µ—Ç–∫–∏ (email_threads)

- `subject_normalized` ‚Äî —Ç–µ–º–∞ –±–µ–∑ Re:/Fwd:
- `status` ‚Äî open/pending_resolution/resolved/archived
- `summary_short/detailed` ‚Äî AI-—Å–∞–º–º–∞—Ä–∏
- `key_decisions` ‚Äî –º–∞—Å—Å–∏–≤ —Ä–µ—à–µ–Ω–∏–π
- `action_items` ‚Äî –∑–∞–¥–∞—á–∏ (JSON)
- `priority` ‚Äî high/medium/low
- `sentiment` ‚Äî positive/neutral/negative/conflict

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
1. –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —è—â–∏–∫–∏
2. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –ø–∏—Å—å–º–∞ –ø–æ IMAP UID
3. –ü–∞—Ä—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ç–µ–ª–æ, –≤–ª–æ–∂–µ–Ω–∏—è
4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ç–∫—É –ø–æ References ‚Üí In-Reply-To ‚Üí —Ç–µ–º–µ
5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î

### AI-—Å–∞–º–º–∞—Ä–∏
1. –ò—â–µ–º –º–∞—Ä–∫–µ—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: "–¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", "–ø—Ä–∏–Ω—è—Ç–æ", "—É—Ç–≤–µ—Ä–∂–¥–∞—é"...
2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∞–º–º–∞—Ä–∏ —á–µ—Ä–µ–∑ Claude
3. –ò–∑–≤–ª–µ–∫–∞–µ–º: —Ä–µ—à–µ–Ω–∏—è, –∑–∞–¥–∞—á–∏, —Ç–µ–≥–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
4. –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### –í–ª–æ–∂–µ–Ω–∏—è
1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ `YYYY/MM/DD/hash_filename`
2. –°—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ –∞–Ω–∞–ª–∏–∑
3. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/PDF ‚Üí Gemini Vision
4. –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã ‚Üí Claude Haiku
5. –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ ‚Üí –≤ –ë–î –¥–ª—è RAG

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è .env

```env
# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/email_logger

# IMAP (NIC.ru)
IMAP_SERVER=imap.nicmail.ru
IMAP_PORT=993

# Email credentials (EMAIL_N=address,password)
EMAIL_1=accountant@totsamiy.com,SecretPass
EMAIL_2=hr@totsamiy.com,SecretPass
# ... –¥–æ EMAIL_70

# AI
ROUTERAI_API_KEY=your_key
ROUTERAI_BASE_URL=https://api.routerai.com/v1

# Telegram
TELEGRAM_BOT_TOKEN=123456:ABC...
TELEGRAM_ADMIN_IDS=123456789

# Storage
ATTACHMENTS_PATH=/var/email_logger/attachments

# Sync
SYNC_INTERVAL_MINUTES=5
INITIAL_LOAD_DAYS=30
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
```bash
tail -f email_logger.log
journalctl -u email_logger -f
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```sql
-- –Ø—â–∏–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
SELECT email, last_error FROM monitored_mailboxes WHERE sync_status = 'error';

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
SELECT DATE(received_at), COUNT(*) FROM email_messages GROUP BY 1 ORDER BY 1 DESC;

-- –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–µ—Ç–∫–∏
SELECT subject_normalized, message_count, priority FROM email_threads WHERE status = 'open';
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `.env` (–Ω–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!)
- IMAP —á–µ—Ä–µ–∑ SSL (–ø–æ—Ä—Ç 993)
- –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Ä–æ–ª—è–º–∏
- –í–ª–æ–∂–µ–Ω–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ö—ç—à–∞–º–∏

## üìù TODO

- [ ] IMAP IDLE –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–° –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- [ ] Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–µ—Ç–æ–∫
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ Outline Wiki
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–∞–∂–Ω—ã—Ö –ø–∏—Å—å–º–∞—Ö

---

*–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è Frumelad / –ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∞—è –ü—Ä–æ—Ö–æ—Ä–æ–≤–∞*
